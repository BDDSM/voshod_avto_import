# encoding: utf-8
module VoshodAvtoImport

  class ChelImportParser < ::VoshodAvtoImport::BaseParser

    CATALOGS_DEPS = {

      'НОМЕНКЛАТУРА АКСЕССУАРОВ'  => 1,
      'Аксессуары'                => 1,
      'Автоаксессуары'            => 1,

      'НОМЕНКЛАТУРА АВТОХИМИИ'    => 2,
      'Автохимия'                 => 2,
      'Химия'                     => 2,
      'Автохимия и масло'         => 2,

      'Инструменты'               => 3,
      'Инструмент'                => 3,
      'НОМЕНКЛАТУРА ИНСТРУМЕНТОВ' => 3,

      'АВТО_ВАЗ'                  => 4,
      'НОМЕНКЛАТУРА ВАЗ'          => 4,
      'ВАЗ'                       => 4,
      'Запчасти ВАЗ'              => 4,

      'НОМЕНКЛАТУРА ГАЗ'          => 5,
      'ГАЗ'                       => 5,
      'Аккумуляторы'              => 5,
      'Запчасти ГАЗ'              => 5,

      'НОМЕНКЛАТУРА ИНОМАРОК'     => 6,
      'Иномарки'                  => 6,
      'Запчасти иномарки'         => 6

    }.freeze

    ITEMS_DEPS = {

      'Аксессуары'  => 1,

      'Автохимия'   => 2,
      'Химия'       => 2,

      'Инструменты' => 3,
      'Инструмент'  => 3,

      'ВАЗ'         => 4,
      'ГАЗ'         => 5,
      'Иномарки'    => 6

    }.freeze

    def initialize(saver)

      super(saver)

      @level              = 0
      @tags               = {}
      @catalogs_item_map  = {}

      start_parse_catalogs

    end # initialize

    def start_element(name, attrs = [])

      super(name, attrs)

      attrs  = ::Hash[attrs]
      @level += 1
      @tags[@level] = name

      case name

        # 1C 8 (дополнительно)
        when 'Каталог'        then
          parse_partial(attrs)

        # 1C 8 (свойства)
        when 'Свойства'       then
          start_parse_properties

        when 'Свойство'       then
          start_parse_property

        when 'Группа'         then
          up_catalog_level
          start_parse_catalog

        when 'Группы'         then
          stop_parse_catalog
          change_catalog_parent

        # 1C 8 (товары)
        when 'Товары'         then
          start_parse_items

        when 'Товар'          then
          start_parse_item

        # 1C 8 (свойства товаров)
        when 'ЗначенияСвойства' then
          start_parse_item_property

      end # case

    end # start_element

    def end_element(name)

      @level -= 1

      case name

        # 1C 8 (каталоги)
        when 'Классификатор'  then
          stop_parse_catalogs

        when 'Группа'         then
          stop_parse_catalog
          down_catalog_level

        # 1С 8 (товары)
        when 'Товары'         then
          stop_parse_items

        when 'Товар'          then
          stop_parse_item

        # 1C (общее)
        when 'Ид'             then
          grub_catalog(:id)
          grub_item(:id)
          grub_catalog_for_item(:catalog_id)
          grub_property(:id)
          grub_item_property(:id)

        when 'Значение'       then
          grub_item_property(:value)

        when 'Отдел'          then
          grub_item(:department)

        when 'Артикул'        then
          grub_item(:mog)

        when 'АртикулПроизводителя'   then
          grub_item(:mog_vendor)

        when 'Наименование'   then
          grub_item(:name)
          grub_catalog(:name)
          grub_property(:name)

        when 'КодСтранаПроисхождения' then
          grub_item(:country_code)

        when 'СтранаПроисхождения'    then
          grub_item(:country)

        when 'НомерГТД'       then
          grub_item(:gtd)

        when 'Производитель'  then
          grub_item(:vendor)

        when 'БазоваяЕдиница' then
          grub_item(:unit)

        when 'ДополнительноеОписаниеНоменклатуры' then
          grub_item(:crosses)

        # 1C 8 (свойства)
        when 'Свойства'       then
          stop_parse_properties

        when 'Свойство'       then
          stop_parse_property

        # 1C 8 (свойства товаров)
        when 'ЗначенияСвойства' then
          stop_parse_item_property

      end # case

    end # end_element

    private

    def reset_datas!

      @catalog_level        = 0
      @catalog_parent_id    = {}
      @catalog              = {}
      @catalogs_array       = []

    end # reset_datas!

    def parent_tag
      @tags[@level+0] || ""
    end # parent_tag

    def change_catalog_parent

      return if @start_parse_catalogs != true
      @catalog_parent_id[@catalog_level] = @catalog[:key_1c]

    end # change_catalog_parent

    def start_parse_catalogs

      return if @start_parse_catalogs == true

      @start_parse_catalogs = true
      reset_datas!

      @catalogs_array << {

        id:             "chel",
        key_1c:         "chel",
        key_1c_parent:  nil,
        dep_code:       0,
        name:           "Челябинск"

      }

      @catalog_parent_id[0]       = "chel"
      @catalogs_item_map["chel"]  = 0

    end # start_parse_catalogs

    def stop_parse_catalogs

      return if @start_parse_catalogs != true

      @start_parse_catalogs = false

      @catalogs_array.each do |catalog|
        @saver.save_catalog(catalog)
      end

      reset_datas!

    end # stop_parse_catalogs

    def start_parse_catalog

      return if @start_parse_catalogs != true

      @start_parse_catalog = true
      @catalog             = {}

    end # start_parse_catalog

    def stop_parse_catalog

      return if @start_parse_catalog != true

      @start_parse_catalog = false

      if @catalog_level == 1
        @catalog_dep_code = CATALOGS_DEPS[@catalog[:name]]
      end

      @catalog[:dep_code]       = @catalog_dep_code
      @catalog[:key_1c]         = "#{@catalog_dep_code}-#{@catalog[:id]}"
      @catalog[:key_1c_parent]  = @catalog_parent_id[@catalog_level-1] || "chel"

      @catalogs_item_map[@catalog[:id]] = @catalog[:dep_code]

      @catalogs_array << @catalog if catalog_valid?

    end # stop_parse_catalog

    def up_catalog_level
      @catalog_level += 1
    end # up_catalog_level

    def down_catalog_level
      @catalog_level  -= 1
    end # down_catalog_level

    def grub_catalog(attr_name)
      @catalog[attr_name] = @str if for_catalog?
    end # grub_catalog

    def for_catalog?
      @start_parse_catalog == true && parent_tag == "Группа"
    end # for_catalog?

    def parse_partial(attrs)

      @saver.set_partial(
        [true, 'true'].include?(attrs['СодержитТолькоИзменения'])
      )

    end # parse_partial

    def start_parse_items

      return if @start_parse_items == true

      @start_parse_items  = true
      @items              = []

    end # start_parse_items

    def stop_parse_items

      return if @start_parse_items != true

      @start_parse_items = false

      @items.each do |item|
        @saver.save_item(item)
      end

      @items = []

    end # stop_parse_items

    def start_parse_item

      return if @start_parse_items != true

      @start_parse_item = true
      @item             = {
        price: 0
      }

    end # start_parse_item

    def stop_parse_item

      return if @start_parse_item != true

      @start_parse_item = false

      unless (catalog_id = @item[:catalog_id].try(:squish)).nil?

        @item[:dep_code]   = @catalogs_item_map[catalog_id]
        @item[:catalog_1c] = "#{@item[:dep_code]}-#{catalog_id}"

        unless (item_id = @item[:id].squish).blank?
          @item[:key_1c] = "#{@item[:dep_code]}-#{item_id}"
        end

      end

      @items << @item if item_valid?

    end # stop_parse_item

    def for_item?
      @start_parse_item == true && parent_tag == "Товар"
    end # for_item?

    def grub_item(attr_name)
      @item[attr_name] = @str if for_item?
    end # grub_item

    def id_group_for_item?
      @start_parse_item == true && parent_tag == 'Группы'
    end # id_group_for_item?

    def grub_catalog_for_item(attr_name)
      @item[attr_name] = @str if id_group_for_item?
    end # grub_catalog_for_item

    def start_parse_properties

      return if @start_parse_properties == true

      @start_parse_properties = true
      @properties             = {}

    end # start_parse_properties

    def stop_parse_properties

      return if @start_parse_properties != true

      @start_parse_properties = false

    end # stop_parse_properties

    def start_parse_property

      return if @start_parse_properties != true

      @start_parse_property = true
      @property             = {}

    end # start_parse_property

    def stop_parse_property

      return if @start_parse_property != true

      @start_parse_property = false
      @properties[ @property[:id] ] = @property[:name]

    end # stop_parse_property

    def for_property?
      @start_parse_property == true && parent_tag == "Свойство"
    end # for_property?

    def grub_property(attr_name)
      @property[attr_name] = @str if for_property?
    end # grub_property

    def start_parse_item_property

      return if @start_parse_item_property == true

      @start_parse_item_property  = true
      @item_property              = {}

    end # start_parse_item_property

    def stop_parse_item_property

      return if @start_parse_item_property != true

      @start_parse_item_property = false

      if @start_parse_item == true

        @item[:properties]  = @item_property
        @item_property      = {}

      end # if

    end # stop_parse_item_property

    def for_item_property?
      @start_parse_item_property == true && parent_tag == "ЗначенияСвойства"
    end # for_item_property?

    def grub_item_property(attr_name)

      return unless for_item_property?

      if attr_name == :id

        @last_key_property = @properties[@str]
        @item_property[ @last_key_property ] = nil

      elsif attr_name == :value && !@last_key_property.nil?

        @item_property[ @last_key_property ] = @str
        @last_id_property = nil

      end # if

    end # grub_item_property

    def start_parse_item_extend

      return if @start_parse_item_extend == true

      @start_parse_item_extend = true
      @item_extend             = {}

    end # start_parse_item_extend

    def stop_parse_item_extend

      return if @start_parse_item_extend != true

      @start_parse_item_extend = false

      @item_extend.each do |id, values|
        @saver.save_item_extend(id, values)
      end

    end # stop_parse_item_extend

  end # ChelImportParser

end # VoshodAvtoImport
